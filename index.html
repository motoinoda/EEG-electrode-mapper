<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEG Electrode Layout Export Tool</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
        }

        .electrode-count {
            font-size: 1.1em;
            margin-top: 10px;
            opacity: 0.9;
        }

        .content {
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .control-panel {
            width: 350px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
            max-height: 800px;
            overflow-y: auto;
        }

        .electrode-display {
            flex: 1;
            text-align: center;
        }

        .head-container {
            position: relative;
            width: 700px;
            height: 700px;
            margin: 40px auto 0 auto;
        }

        .head-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            z-index: 2;
        }

        .head-border {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid black;
            border-radius: 50%;
            background: transparent;
            z-index: 3;
        }

        .electrode {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid black;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            color: black;
            z-index: 10;
        }

        .electrode:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 15;
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
            font-size: 14px;
        }

        .electrode.active {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .nose-marker {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 45px solid transparent;
            border-right: 45px solid transparent;
            border-bottom: 90px solid black;
            z-index: 1;
        }

        .nose-marker::after {
            content: '';
            position: absolute;
            top: 6px;
            left: -39px;
            width: 0;
            height: 0;
            border-left: 39px solid transparent;
            border-right: 39px solid transparent;
            border-bottom: 78px solid white;
        }

        .ear-marker {
            position: absolute;
            top: 50%;
            width: 35px;
            height: 70px;
            background: white;
            border: 3px solid black;
            border-radius: 0 20px 20px 0;
            transform: translateY(-50%);
        }

        .ear-left {
            left: -40px;
            border-radius: 20px 0 0 20px;
            border-right: none;
        }

        .ear-right {
            right: -40px;
            border-left: none;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .button {
            width: 100%;
            padding: 10px;
            margin: 3px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .button.primary {
            background: #3498db;
            color: white;
        }

        .button.primary:hover {
            background: #2980b9;
        }

        .button.warning {
            background: #f39c12;
            color: white;
        }

        .button.warning:hover {
            background: #e67e22;
        }

        .button.success {
            background: #27ae60;
            color: white;
        }

        .button.success:hover {
            background: #229954;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }

        .selected-count {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
        }

        .electrode-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            font-size: 10px;
        }

        .electrode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .electrode-item:hover {
            background-color: #f8f9fa;
        }

        .electrode-item.highlighted {
            background-color: #e8f5e8;
            font-weight: bold;
        }

        .electrode-item:last-child {
            border-bottom: none;
        }

        .electrode-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .search-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .stats {
            background: #ecf0f1;
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            margin-top: 10px;
        }

        .edit-mode .electrode {
            cursor: text;
        }

        .electrode-editor {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
        }

        .electrode-editor h3 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }

        .electrode-editor input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }

        .electrode-editor-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .electrode-editor-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .save-btn {
            background: #27ae60;
            color: white;
        }

        .cancel-btn {
            background: #e74c3c;
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* PDF container styles (hidden from display) */
        .pdf-container {
            display: none;
            width: 700px;
            height: 700px;
            position: relative;
            background: white;
        }

        .pdf-electrode {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid black;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transform: translate(-50%, -50%);
            color: black;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="statusIndicator">
        Select electrodes
    </div>

    <div class="container">
        <div class="header">
            <h1>EEG Electrode Layout Export Tool</h1>
            <div class="electrode-count">Export electrode layout diagrams in SVG/PNG format</div>
        </div>

        <div class="content">
            <div class="control-panel">
                <div class="selected-count">
                    Selected: <span id="selectedCount">0</span> electrodes
                </div>

                <div class="control-group">
                    <h3>Electrode Search</h3>
                    <input type="text" id="searchBox" class="search-box" placeholder="Search by electrode name (e.g. Cz, F3)">
                </div>

                <div class="control-group">
                    <h3>Selection Presets</h3>
                    <div class="preset-buttons">
                        <button class="button primary" onclick="selectPreset('frontal')">Frontal</button>
                        <button class="button primary" onclick="selectPreset('central')">Central</button>
                        <button class="button primary" onclick="selectPreset('parietal')">Parietal</button>
                        <button class="button primary" onclick="selectPreset('occipital')">Occipital</button>
                        <button class="button primary" onclick="selectPreset('temporal')">Temporal</button>
                        <button class="button primary" onclick="selectPreset('all')">Select All</button>
                    </div>
                    <button class="button warning" onclick="clearSelection()">Clear All</button>
                </div>

                <div class="control-group">
                    <h3>Electrode Editing</h3>
                    <button class="button primary" onclick="toggleEditMode()" id="editModeButton">Edit Mode: OFF</button>
                    <div style="font-size: 10px; margin-top: 5px; color: #666;">
                        When edit mode is ON, click electrodes to change their names
                    </div>
                </div>

                <div class="control-group">
                    <h3>File Export</h3>
                    <button class="button success" onclick="saveSVG()" id="svgButton">Export SVG</button>
                    <button class="button success" onclick="savePNG()" id="pngButton">Export PNG</button>
                    <div style="font-size: 10px; margin-top: 5px; color: #666;">
                        Export files containing only selected electrodes (all client-side processing)
                    </div>
                </div>

                <div class="control-group">
                    <h3>Selected Electrodes List</h3>
                    <div id="selectedElectrodeList" class="electrode-list">
                        Selected electrodes will be displayed here
                    </div>
                </div>

                <div class="stats">
                    <strong>How to Use</strong><br>
                    1. Click electrodes to select (highlighted in red)<br>
                    2. Use preset buttons for region-specific selection<br>
                    3. Turn on "Edit Mode" to modify electrode names<br>
                    4. "Export SVG" or "Export PNG" to save layout diagram<br>
                    5. Exported files contain only selected electrodes
                </div>
            </div>

            <div class="electrode-display">
                <div class="head-container" id="headContainer">
                    <div class="nose-marker"></div>
                    <div class="head-background"></div>
                    <div class="head-border"></div>
                    <div class="ear-marker ear-left"></div>
                    <div class="ear-marker ear-right"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden container for PDF generation -->
    <div class="pdf-container" id="pdfContainer">
        <div class="head-background" style="width: 100%; height: 100%; border-radius: 50%; background: white; position: absolute;"></div>
        <div class="head-border" style="width: 100%; height: 100%; border: 3px solid black; border-radius: 50%; background: transparent; position: absolute;"></div>
        <div class="nose-marker" style="position: absolute; top: -45px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 45px solid transparent; border-right: 45px solid transparent; border-bottom: 90px solid black;"></div>
        <div class="ear-marker ear-left" style="position: absolute; top: 50%; left: -40px; width: 35px; height: 70px; background: white; border: 3px solid black; border-radius: 20px 0 0 20px; border-right: none; transform: translateY(-50%);"></div>
        <div class="ear-marker ear-right" style="position: absolute; top: 50%; right: -40px; width: 35px; height: 70px; background: white; border: 3px solid black; border-radius: 0 20px 20px 0; border-left: none; transform: translateY(-50%);"></div>
    </div>

    <script>
        // Electrode data (numbers removed)
        const electrodeData = [
            {"name": "Nz", "x": -0.002352941176470588, "y": 0.7588652482269503},
            {"name": "Fpz", "x": -0.002352941176470588, "y": 0.5981087470449172},
            {"name": "Fp2", "x": 0.19058823529411764, "y": 0.5697399527186762},
            {"name": "Fp1", "x": -0.18588235294117647, "y": 0.5650118203309693},
            {"name": "AF7", "x": -0.3788235294117647, "y": 0.4562647754137116},
            {"name": "AF8", "x": 0.3788235294117647, "y": 0.4562647754137116},
            {"name": "AFz", "x": -0.002352941176470588, "y": 0.4231678486997636},
            {"name": "AF4", "x": 0.22823529411764706, "y": 0.4231678486997636},
            {"name": "AF3", "x": -0.2235294117647059, "y": 0.41843971631205673},
            {"name": "F9", "x": -0.68, "y": 0.375886524822695},
            {"name": "F10", "x": 0.6847058823529412, "y": 0.375886524822695},
            {"name": "F8", "x": 0.5152941176470588, "y": 0.3191489361702128},
            {"name": "F7", "x": -0.5105882352941177, "y": 0.3144208037825059},
            {"name": "F6", "x": 0.3976470588235294, "y": 0.2860520094562648},
            {"name": "F5", "x": -0.39294117647058824, "y": 0.28132387706855794},
            {"name": "F3", "x": -0.26588235294117646, "y": 0.26713947990543735},
            {"name": "F4", "x": 0.26588235294117646, "y": 0.26713947990543735},
            {"name": "F1", "x": -0.12941176470588237, "y": 0.2576832151300236},
            {"name": "F2", "x": 0.12941176470588237, "y": 0.2576832151300236},
            {"name": "Fz", "x": 0.002352941176470588, "y": 0.25295508274231676},
            {"name": "FC10", "x": 0.7694117647058824, "y": 0.13947990543735225},
            {"name": "FC9", "x": -0.7694117647058824, "y": 0.1347517730496454},
            {"name": "FC8", "x": 0.6047058823529412, "y": 0.12529550827423167},
            {"name": "FC7", "x": -0.6047058823529412, "y": 0.12056737588652482},
            {"name": "FC5", "x": -0.4541176470588235, "y": 0.10638297872340426},
            {"name": "FC6", "x": 0.4541176470588235, "y": 0.10638297872340426},
            {"name": "FC3", "x": -0.2988235294117647, "y": 0.09219858156028368},
            {"name": "FC4", "x": 0.2988235294117647, "y": 0.09219858156028368},
            {"name": "FC1", "x": -0.15294117647058825, "y": 0.08747044917257683},
            {"name": "FC2", "x": 0.15294117647058825, "y": 0.08747044917257683},
            {"name": "FCz", "x": -0.002352941176470588, "y": 0.07801418439716312},
            {"name": "M1", "x": -0.9294117647058824, "y": -0.07801418439716312},
            {"name": "T9", "x": -0.8070588235294117, "y": -0.07801418439716312},
            {"name": "T7", "x": -0.6470588235294118, "y": -0.07801418439716312},
            {"name": "C5", "x": -0.4823529411764706, "y": -0.07801418439716312},
            {"name": "C3", "x": -0.32235294117647056, "y": -0.07801418439716312},
            {"name": "C1", "x": -0.15764705882352942, "y": -0.07801418439716312},
            {"name": "Cz", "x": -0.002352941176470588, "y": -0.07801418439716312},
            {"name": "C2", "x": 0.1623529411764706, "y": -0.07801418439716312},
            {"name": "C4", "x": 0.32235294117647056, "y": -0.07801418439716312},
            {"name": "C6", "x": 0.4823529411764706, "y": -0.07801418439716312},
            {"name": "T8", "x": 0.6423529411764706, "y": -0.07801418439716312},
            {"name": "T10", "x": 0.8070588235294117, "y": -0.07801418439716312},
            {"name": "M2", "x": 0.9294117647058824, "y": -0.07801418439716312},
            {"name": "CPz", "x": -0.002352941176470588, "y": -0.23877068557919623},
            {"name": "CP1", "x": -0.14823529411764705, "y": -0.25295508274231676},
            {"name": "CP2", "x": 0.15294117647058825, "y": -0.25295508274231676},
            {"name": "CP3", "x": -0.2988235294117647, "y": -0.2576832151300236},
            {"name": "CP4", "x": 0.2988235294117647, "y": -0.2576832151300236},
            {"name": "CP5", "x": -0.44941176470588234, "y": -0.2718676122931442},
            {"name": "CP6", "x": 0.4541176470588235, "y": -0.2718676122931442},
            {"name": "TP7", "x": -0.6, "y": -0.2907801418439716},
            {"name": "TP8", "x": 0.6047058823529412, "y": -0.2907801418439716},
            {"name": "TP9", "x": -0.7647058823529411, "y": -0.30023640661938533},
            {"name": "TP10", "x": 0.7694117647058824, "y": -0.30023640661938533},
            {"name": "Pz", "x": -0.002352941176470588, "y": -0.41843971631205673},
            {"name": "P1", "x": -0.12470588235294118, "y": -0.4231678486997636},
            {"name": "P2", "x": 0.12941176470588237, "y": -0.4231678486997636},
            {"name": "P3", "x": -0.2611764705882353, "y": -0.4326241134751773},
            {"name": "P4", "x": 0.2611764705882353, "y": -0.4326241134751773},
            {"name": "P5", "x": -0.39294117647058824, "y": -0.4515366430260047},
            {"name": "P6", "x": 0.3976470588235294, "y": -0.4515366430260047},
            {"name": "P7", "x": -0.5105882352941177, "y": -0.4846335697399527},
            {"name": "P8", "x": 0.5058823529411764, "y": -0.4846335697399527},
            {"name": "P9", "x": -0.68, "y": -0.541371158392435},
            {"name": "P10", "x": 0.6847058823529412, "y": -0.541371158392435},
            {"name": "PO3", "x": -0.2235294117647059, "y": -0.5886524822695035},
            {"name": "POz", "x": -0.002352941176470588, "y": -0.5886524822695035},
            {"name": "PO4", "x": 0.2235294117647059, "y": -0.5886524822695035},
            {"name": "PO7", "x": -0.37411764705882355, "y": -0.6217494089834515},
            {"name": "PO8", "x": 0.3788235294117647, "y": -0.6217494089834515},
            {"name": "O1", "x": -0.18588235294117647, "y": -0.735224586288416},
            {"name": "O2", "x": 0.18588235294117647, "y": -0.735224586288416},
            {"name": "Oz", "x": -0.002352941176470588, "y": -0.7588652482269503},
            {"name": "Iz", "x": -0.002352941176470588, "y": -0.9290780141843972}
        ];

        let selectedElectrodes = new Set();
        let editMode = false;
        let currentEditingElectrode = null;

        // Electrode layout presets
        const presets = {
            frontal: ['Fp1', 'Fp2', 'Fpz', 'AF3', 'AF4', 'AF7', 'AF8', 'AFz', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'Fz'],
            central: ['FC1', 'FC2', 'FC3', 'FC4', 'FC5', 'FC6', 'FCz', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'Cz'],
            parietal: ['CP1', 'CP2', 'CP3', 'CP4', 'CP5', 'CP6', 'CPz', 'P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8', 'Pz'],
            occipital: ['PO3', 'PO4', 'PO7', 'PO8', 'POz', 'O1', 'O2', 'Oz'],
            temporal: ['T7', 'T8', 'T9', 'T10', 'TP7', 'TP8', 'TP9', 'TP10', 'FC7', 'FC8', 'FC9', 'FC10'],
            all: electrodeData.map(e => e.name)
        };

        function initializeApplication() {
            console.log('Electrode data loaded successfully:', electrodeData.length, 'electrodes');
            initializeElectrodes();
            updateSelectedElectrodesList();

            const status = document.getElementById('statusIndicator');
            status.textContent = 'Select electrodes';
            status.style.background = '#3498db';
        }

        function initializeElectrodes() {
            const container = document.getElementById('headContainer');
            container.querySelectorAll('.electrode').forEach(el => el.remove());

            electrodeData.forEach(electrode => {
                const div = document.createElement('div');
                div.className = 'electrode';
                div.id = `electrode-${electrode.name}`;

                const scale = 400;
                const x = electrode.x * scale + 350;
                const y = -electrode.y * scale + 350 - 30;

                div.style.left = x + 'px';
                div.style.top = y + 'px';
                div.textContent = electrode.name;
                div.title = electrode.name;

                div.onclick = () => {
                    if (editMode) {
                        openElectrodeEditor(electrode);
                    } else {
                        toggleElectrode(electrode.name);
                    }
                };
                container.appendChild(div);
            });

            // Search functionality
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                electrodeData.forEach(electrode => {
                    const element = document.getElementById(`electrode-${electrode.name}`);
                    const matchesName = electrode.name.toLowerCase().includes(searchTerm);

                    if (matchesName || !searchTerm) {
                        element.style.opacity = '1';
                        element.style.transform = 'translate(-50%, -50%) scale(1.2)';
                        element.style.zIndex = '12';
                    } else {
                        element.style.opacity = '0.3';
                        element.style.transform = 'translate(-50%, -50%) scale(1)';
                        element.style.zIndex = '10';
                    }
                });
            });
        }

        function toggleElectrode(name) {
            if (selectedElectrodes.has(name)) {
                selectedElectrodes.delete(name);
                document.getElementById(`electrode-${name}`).classList.remove('active');
            } else {
                selectedElectrodes.add(name);
                document.getElementById(`electrode-${name}`).classList.add('active');
            }
            updateSelectedCount();
            updateSelectedElectrodesList();
        }

        function selectPreset(presetName) {
            if (presets[presetName]) {
                presets[presetName].forEach(name => {
                    if (electrodeData.some(e => e.name === name)) {
                        selectedElectrodes.add(name);
                        const element = document.getElementById(`electrode-${name}`);
                        if (element) element.classList.add('active');
                    }
                });
                updateSelectedCount();
                updateSelectedElectrodesList();
            }
        }

        function clearSelection() {
            selectedElectrodes.clear();
            document.querySelectorAll('.electrode').forEach(el => {
                el.classList.remove('active');
            });
            updateSelectedCount();
            updateSelectedElectrodesList();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedElectrodes.size;

            const svgButton = document.getElementById('svgButton');
            const pngButton = document.getElementById('pngButton');
            if (selectedElectrodes.size > 0) {
                svgButton.textContent = `Export SVG (${selectedElectrodes.size} electrodes)`;
                pngButton.textContent = `Export PNG (${selectedElectrodes.size} electrodes)`;
            } else {
                svgButton.textContent = 'Export SVG';
                pngButton.textContent = 'Export PNG';
            }
        }

        function updateSelectedElectrodesList() {
            const listContainer = document.getElementById('selectedElectrodeList');
            listContainer.innerHTML = '';

            if (selectedElectrodes.size === 0) {
                listContainer.innerHTML = '<div style="color: #999;">No electrodes selected</div>';
                return;
            }

            const sortedElectrodes = Array.from(selectedElectrodes).sort();
            sortedElectrodes.forEach(name => {
                const item = document.createElement('div');
                item.className = 'electrode-item';
                item.innerHTML = `<span class="electrode-name">${name}</span>`;
                item.onclick = () => toggleElectrode(name);
                listContainer.appendChild(item);
            });
        }

        function createSVG() {
            if (selectedElectrodes.size === 0) {
                alert('Please select electrodes');
                return null;
            }

            // Get actual dimensions from web display
            const headContainer = document.getElementById('headContainer');
            const containerRect = headContainer.getBoundingClientRect();
            const svgWidth = containerRect.width + 100; // Add margin
            const svgHeight = containerRect.height + 100; // Minimal margin

            let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">`;
            svg += '<rect width="100%" height="100%" fill="white"/>';

            // SVG center coordinates
            const svgCenterX = svgWidth / 2;
            const svgCenterY = svgHeight / 2;

            // Web head container actual dimensions
            const headRadius = containerRect.width / 2;

            // Head background circle
            svg += `<circle cx="${svgCenterX}" cy="${svgCenterY}" r="${headRadius}" fill="white" stroke="black" stroke-width="3"/>`;

            // Nose triangle (same size as web)
            svg += `<polygon points="${svgCenterX - 45/2},${svgCenterY - headRadius - 10} ${svgCenterX + 45/2},${svgCenterY - headRadius - 10} ${svgCenterX},${svgCenterY - headRadius - 45}" fill="white" stroke="black" stroke-width="6"/>`;
            svg += `<polygon points="${svgCenterX - 39/2},${svgCenterY - headRadius - 4} ${svgCenterX + 39/2},${svgCenterY - headRadius - 4} ${svgCenterX},${svgCenterY - headRadius - 39}" fill="white"/>`;

            // Ears
            const earWidth = 35;
            const earHeight = 70;
            // Left ear
            svg += `<rect x="${svgCenterX - headRadius - 38}" y="${svgCenterY - earHeight/2}" width="${earWidth}" height="${earHeight}" fill="white" stroke="black" stroke-width="3" rx="20"/>`;
            // Right ear
            svg += `<rect x="${svgCenterX + headRadius + 3}" y="${svgCenterY - earHeight/2}" width="${earWidth}" height="${earHeight}" fill="white" stroke="black" stroke-width="3" rx="20"/>`;

            // Draw only selected electrodes (using web's actual positions)
            selectedElectrodes.forEach(name => {
                const electrode = electrodeData.find(e => e.name === name);
                if (electrode) {
                    // Same coordinate transformation as web
                    const scale = 400;
                    const webX = electrode.x * scale + 350;
                    const webY = -electrode.y * scale + 350 - 30;

                    // Convert to SVG coordinate system (move Y coordinate up)
                    const svgX = svgCenterX + (webX - 350);
                    const svgY = svgCenterY + (webY - 350); // Align accurately to web center

                    // Electrode circle (larger size for better visibility in saved files)
                    svg += `<circle cx="${svgX}" cy="${svgY}" r="24" fill="white" stroke="black" stroke-width="3"/>`;

                    // Electrode name (larger font size for better visibility in saved files)
                    svg += `<text x="${svgX}" y="${svgY}" font-family="Arial" font-size="20" text-anchor="middle" dominant-baseline="central" font-weight="bold">${electrode.name}</text>`;
                }
            });

            svg += '</svg>';
            return svg;
        }

        function saveSVG() {
            const svgContent = createSVG();
            if (!svgContent) return;

            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `EEG_electrode_layout_${selectedElectrodes.size}electrodes_${new Date().toISOString().slice(0,10)}.svg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSuccessMessage('SVG export completed');
        }

        function savePNG() {
            const svgContent = createSVG();
            if (!svgContent) return;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = 900;

            const img = new Image();
            const svgBlob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                ctx.drawImage(img, 0, 0);

                canvas.toBlob(function(blob) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `EEG_electrode_layout_${selectedElectrodes.size}electrodes_${new Date().toISOString().slice(0,10)}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 'image/png');

                URL.revokeObjectURL(url);
                showSuccessMessage('PNG export completed');
            };

            img.src = url;
        }

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const body = document.body;
            const button = document.getElementById('editModeButton');

            if (editMode) {
                body.classList.add('edit-mode');
                button.textContent = 'Edit Mode: ON';
                button.style.background = '#e74c3c';
                showMessage('Edit mode is ON. Click electrodes to edit their names.');
            } else {
                body.classList.remove('edit-mode');
                button.textContent = 'Edit Mode: OFF';
                button.style.background = '#3498db';
                showMessage('Edit mode is OFF.');
            }
        }

        // Open electrode editor dialog
        function openElectrodeEditor(electrode) {
            currentEditingElectrode = electrode;

            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = closeElectrodeEditor;

            const editor = document.createElement('div');
            editor.className = 'electrode-editor';
            editor.innerHTML = `
                <h3>Edit Electrode Name</h3>
                <p>Coordinates: (${electrode.x.toFixed(3)}, ${electrode.y.toFixed(3)})</p>
                <label>Current name:</label>
                <input type="text" id="electrodeNameInput" value="${electrode.name}" placeholder="Enter electrode name">
                <div class="electrode-editor-buttons">
                    <button class="save-btn" onclick="saveElectrodeName()">Save</button>
                    <button class="cancel-btn" onclick="closeElectrodeEditor()">Cancel</button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(editor);

            // Focus on input
            setTimeout(() => {
                document.getElementById('electrodeNameInput').select();
            }, 100);
        }

        // Save electrode name
        function saveElectrodeName() {
            if (!currentEditingElectrode) return;

            const newName = document.getElementById('electrodeNameInput').value.trim();
            if (newName && newName !== currentEditingElectrode.name) {
                const oldName = currentEditingElectrode.name;

                // Update data
                currentEditingElectrode.name = newName;

                // Update display
                const element = document.getElementById(`electrode-${oldName}`);
                if (element) {
                    element.id = `electrode-${newName}`;
                    element.textContent = newName;
                    element.title = newName;
                }

                // Update selection set
                if (selectedElectrodes.has(oldName)) {
                    selectedElectrodes.delete(oldName);
                    selectedElectrodes.add(newName);
                }

                // Update list
                updateSelectedElectrodesList();

                showMessage(`Electrode name changed from "${oldName}" to "${newName}".`);
            }

            closeElectrodeEditor();
        }

        // Close edit dialog
        function closeElectrodeEditor() {
            const overlay = document.querySelector('.overlay');
            const editor = document.querySelector('.electrode-editor');
            if (overlay) overlay.remove();
            if (editor) editor.remove();
            currentEditingElectrode = null;
        }

        function showMessage(message) {
            const status = document.getElementById('statusIndicator');
            status.textContent = message;
            status.style.background = '#27ae60';
            setTimeout(() => {
                status.textContent = 'Select electrodes';
                status.style.background = '#3498db';
            }, 3000);
        }

        function showSuccessMessage(message) {
            const status = document.getElementById('statusIndicator');
            status.textContent = message;
            status.style.background = '#27ae60';
            setTimeout(() => {
                status.textContent = 'Select electrodes';
                status.style.background = '#3498db';
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC key to close edit dialog
            if (e.key === 'Escape') {
                closeElectrodeEditor();
            }
            // Enter key to save
            if (e.key === 'Enter' && currentEditingElectrode) {
                saveElectrodeName();
            }
        });

        // Initialize
        window.onload = function() {
            initializeApplication();
        };
    </script>
</body>
</html>